/*
 ClosureCompiler.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/ClosureCompiler.js for details
*/
(function(v){if("function"!=typeof require||!module||!module.exports||!process)throw Error("ClosureCompiler.js can only be used within node.js");var m=require("path"),h=require("fs"),r=require("child_process"),t=require("bl");h.existsSync||(h.existsSync=m.existsSync);var d=function(b){this.options="object"===typeof b&&b?b:{}};d._assertOption=function(b,d,k){if(0>k.indexOf(d))throw"Illegal "+b+" value: "+d+" ("+k+" expected)";};d.JAVA_EXT="win32"==process.platform?".exe":"";d.getGlobalJava=function(){var b=
null;process.env.JAVA_HOME&&(b=m.join(process.env.JAVA_HOME,"bin","java"+d.JAVA_EXT),h.existsSync(b)||(b=null));b||(b="java");return b};d.getBundledJava=function(){return m.normalize(m.join(__dirname,"jre","bin","java"+d.JAVA_EXT))};d.testJava=function(b,d){r.exec('"'+b+'" -version',{},function(b,h,p){p+="";p.match(/1\.[7-8]+/)?d(!0,null):0<=p.indexOf('version "')?d(!1,Error("Not Java 7")):d(!1,b)})};d.compile=function(b,h,k,m){4>arguments.length&&(m=k,k=null);(new d(h)).compile(b,k,m)};d.prototype.compile=
function(b,q,k){function u(a,b,c,d){var e=t(),f=t();a=r.spawn(a,b,{stdio:[c||"ignore","pipe","pipe"]});a.stdout.pipe(e);a.stderr.pipe(f);a.on("exit",function(a,b){var c;a&&(c=Error(a),c.code=a,c.signal=b);d(c,e,f)});a.on("error",function(a){d(a,e,f)})}function p(a,b){u(a,b,q,function(a,b,c){0<b.length||0<c.length?k(c+"",b+""):k(a,null)})}3>arguments.length&&(k=q,q=null);for(var c={},g=Object.keys(this.options),a=0;a<g.length;a++)c[g[a].toLowerCase()]=this.options[g[a]];delete c.js;delete c.js_output_file;
var a=c.xms||null,e=c.xmx||"1024m";delete c.xms;delete c.xmx;var l=["-XX:+TieredCompilation"];a&&l.push("-Xms"+a);l.push("-Xmx"+e,"-jar",__dirname+"/compiler/compiler.jar");b instanceof Array||(b=[b]);for(a=0;a<b.length;a++){if("string"!=typeof b[a])throw Error("Illegal source file: "+b[a]);if(0<=b[a].indexOf('"'))l.push("--js="+b[a]);else{e=h.statSync(b[a]);if(!e.isFile())throw Error("Source file not found: "+b[a]);l.push("--js",b[a])}}c.externs||(c.externs=[]);c.externs instanceof Array||(c.externs=
[c.externs]);g=[];for(a=0;a<c.externs.length;a++){if("string"!=typeof c.externs[a]||""==c.externs[a])throw Error("Externs directive does not point to a file or directory: "+c.externs[a]);"node"==c.externs[a].toLowerCase()&&(c.externs[a]=__dirname+"/node_modules/closurecompiler-externs");e=h.statSync(c.externs[a]);if(e.isDirectory())for(var n=h.readdirSync(c.externs[a]),e=0;e<n.length;e++){var f=c.externs[a]+"/"+n[e];h.statSync(f).isFile()&&".js"==m.extname(f).toLowerCase()&&g.push(f)}else if(e.isFile())g.push(c.externs[a]);
else throw Error("Externs file not found: "+c.externs[a]);}delete c.externs;for(a=0;a<g.length;a++)l.push("--externs",g[a]);g=Object.keys(c);for(a=0;a<g.length;a++){n=g[a];f=c[g[a]];if(!/[a-zA-Z0-9_]+/.test(n))throw Error("Illegal option: "+n);if(!0===f)l.push("--"+n);else if(!1!==f)for(f instanceof Array||(f=[f]),e=0;e<f.length;e++){if(!/[^\s]*/.test(f[e]))throw Error("Illegal value for option "+n+": "+f[e]);l.push("--"+n,f[e])}}d.testJava(d.getGlobalJava(),function(a){a?p(d.getGlobalJava(),l):d.testJava(d.getBundledJava(),
function(a){if(a)p(d.getBundledJava(),l);else throw Error("Java is not available, neither the bundled nor a global one.");})})};d.prototype.toString=function(){return"ClosureCompiler"};module.exports=d})(this);
